#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#
name: GPT Build

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      REPO_URL:
        description: 'Source repository'
        required: true
        default: 'https://github.com/Yuzhii0718/bl-mt798x-dhcpd'
        type: string
      REPO_BRANCH:
        description: 'Repository branch'
        required: true
        default: 'master'
        type: string
      GPT_TEMPLATE:
        description: 'Include template partition table'
        required: false
        default: false
        type: boolean

env:
  REPO_URL: ${{ github.event.inputs.REPO_URL }}
  REPO_BRANCH: ${{ github.event.inputs.REPO_BRANCH }}
  TZ: Asia/Shanghai
  UPLOAD_ARTIFACT: true
  UPLOAD_RELEASE: true

jobs:
  build-gpt:
    runs-on: ubuntu-22.04

    permissions:
      contents: write

    steps:
      - name: 检查项目分支
        uses: actions/checkout@master

      - name: 初始化编译环境
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install git rename python2.7 python2.7-dev python3
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: 下载源码
        working-directory: /workdir
        run: |
          df -hT $PWD
          git clone $REPO_URL -b $REPO_BRANCH bl-mt798x-dhcpd
          ln -sf /workdir/bl-mt798x-dhcpd $GITHUB_WORKSPACE/bl-mt798x-dhcpd

      - name: 准备 GPT 输入
        shell: bash
        run: |
          set -euo pipefail
          cd bl-mt798x-dhcpd

          if [ "${{ github.event.inputs.GPT_TEMPLATE }}" = "true" ]; then
            if [ -d "mt798x_gpt/template" ]; then
              echo "启用模板分区表：复制 mt798x_gpt/template/* -> mt798x_gpt/"
              shopt -s dotglob nullglob
              cp -af mt798x_gpt/template/* mt798x_gpt/ || true
            else
              echo "Warning: 未找到 mt798x_gpt/template 目录，跳过模板复制"
            fi
          else
            echo "未启用模板分区表（GPT_TEMPLATE=false）"
          fi

      - name: 编译 GPT
        id: gpt
        shell: bash
        run: |
          set -euo pipefail
          cd bl-mt798x-dhcpd
          chmod +x ./generate_gpt.sh
          ./generate_gpt.sh
          echo "FILE_DATE=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: 整理文件并重命名
        id: organize
        if: env.UPLOAD_ARTIFACT == 'true' && !cancelled()
        shell: bash
        run: |
          set -euo pipefail
          cd bl-mt798x-dhcpd

          TIMESTAMP=$(date +"%Y%m%d-%H%M%S")

          # 尝试给 output_gpt 文件打时间戳
          if [ -d "output_gpt" ]; then
            rename "s/(.*)\.(.*)/\$1_${TIMESTAMP}.\$2/" output_gpt/* || true
          fi

          mkdir -p upload
          if [ -d "output_gpt" ]; then
            cp -r output_gpt/* upload/ || true
          fi

          # 也把模板/源文件打包一份，便于追溯
          if [ -d "mt798x_gpt" ]; then
            tar -czf upload/mt798x_gpt_${TIMESTAMP}.tar.gz mt798x_gpt || true
          fi

          echo "status=success" >> $GITHUB_OUTPUT

      - name: 打包上传到Actions Artifacts
        uses: actions/upload-artifact@main
        if: steps.organize.outputs.status == 'success' && !cancelled()
        with:
          name: ${{ env.FILE_DATE }}-gpt-partition-table
          path: |
            bl-mt798x-dhcpd/upload/*

      - name: 生成Release说明
        id: tag
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        shell: bash
        run: |
          set -euo pipefail
          touch release.txt
          echo "- 使用源码：${{ env.REPO_URL }}" >> release.txt
          echo "- 使用分支：${{ env.REPO_BRANCH }}" >> release.txt
          if [ "${{ github.event.inputs.GPT_TEMPLATE }}" = "true" ]; then
            echo "- 已启用：编译模板分区表" >> release.txt
          else
            echo "- 未启用：编译模板分区表" >> release.txt
          fi
          echo "- 编译时间：${{ env.FILE_DATE }}" >> release.txt

          echo "release_tag=${{ env.FILE_DATE }}-gpt-partition-table" >> $GITHUB_OUTPUT
          echo "status=success" >> $GITHUB_OUTPUT

      - name: 发布至Release
        uses: softprops/action-gh-release@v2.1.0
        if: steps.tag.outputs.status == 'success' && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: bl-mt798x-dhcpd/upload/*
          release_name: ${{ env.FILE_DATE }}-gpt-partition-table
          name: ${{ env.FILE_DATE }}-gpt-partition-table
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.txt